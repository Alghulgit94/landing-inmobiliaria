<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Formulario de Reservaci√≥n - Mega Proyectos</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">

    <!-- External Stylesheets -->
    <link rel="stylesheet" href="assets/css/index.css" />
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Meta tags -->
    <meta
      name="description"
      content="Complete su reservaci√≥n de lote en Colonia Independencia. Formulario seguro y f√°cil de usar para asegurar su propiedad ideal."
    />
    <meta
      name="keywords"
      content="reservaci√≥n lotes, formulario reserva, inmobiliaria, Colonia Independencia"
    />
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Formulario de Reservaci√≥n - Mega Proyectos" />
    <meta property="og:description" content="Complete su reservaci√≥n de lote en Colonia Independencia" />
    <meta property="og:type" content="website" />

    <style>
      /* Reservation Form Specific Styles - Redesigned Layout */
      
      /* Main Container */
      .reservation-container {
        min-height: 100vh;
        background: linear-gradient(135deg, var(--color-cream) 0%, var(--color-white) 100%);
        padding: var(--spacing-sm) 0;
      }
      
      .reservation-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 var(--spacing-sm);
      }
      
      /* Top Bar with Back Link and Language Selector */
      .reservation-top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        gap: var(--spacing-md);
      }

      /* Back Link Styling */
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-medium);
        font-size: var(--font-size-xs);
        color: var(--color-green-primary);
        text-decoration: none;
        transition: all var(--transition-fast);
      }

      .back-link:hover {
        color: var(--color-dark-blue);
        transform: translateX(-3px);
      }

      .back-arrow {
        font-size: var(--font-size-sm);
        transition: transform var(--transition-fast);
      }

      .back-link:hover .back-arrow {
        transform: translateX(-2px);
      }

      /* Language Selector Styling */
      .language-selector-wrapper {
        position: relative;
        display: inline-block;
      }

      .language-selector {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: var(--color-white);
        border: 2px solid var(--color-light-gray);
        border-radius: var(--radius-sm);
        padding: var(--spacing-xs) var(--spacing-lg) var(--spacing-xs) var(--spacing-sm);
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--color-primary-dark);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-width: 100px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231F4B43' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right var(--spacing-xs) center;
        background-size: 12px;
      }

      .language-selector:hover {
        border-color: var(--color-green-primary);
        background-color: rgba(255, 248, 246, 0.5);
      }

      .language-selector:focus {
        outline: none;
        border-color: var(--color-green-primary);
        box-shadow: 0 0 0 3px rgba(31, 75, 67, 0.1);
      }

      .language-selector option {
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        padding: var(--spacing-xs);
      }
      
      /* New Layout Grid */
      .reservation-layout {
        display: grid;
        grid-template-columns: 60% 40%;
        gap: var(--spacing-md);
        height: calc(100vh - 80px);
        background-color: var(--color-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        overflow: visible; /* Permitir que el dropdown sea visible fuera del layout */
      }
      
      .form-column {
        padding: var(--spacing-sm);
        overflow-y: auto; /* Scroll interno para el form en desktop */
        max-height: calc(100vh - 80px);
      }
      
      .map-column {
        position: relative;
        background-color: var(--color-light-gray);
        border-left: 1px solid var(--color-light-gray);
        z-index: 1; /* Mantener el mapa por debajo del dropdown */
      }

      #map {
        width: 100%;
        height: 100%;
        min-height: calc(100vh - 80px);
        z-index: 1; /* Mantener el mapa por debajo del dropdown */
      }
      
      /* Compact Header */
      .reservation-header {
        text-align: left;
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--color-light-gray);
      }
      
      .reservation-title {
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-base);
        color: var(--color-green-primary);
        margin-bottom: var(--spacing-xs);
        line-height: var(--line-height-tight);
      }
      
      .reservation-subtitle {
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-normal);
        font-size: var(--font-size-xs);
        color: var(--color-dark-gray);
        line-height: var(--line-height-normal);
        margin: 0;
      }
      
      /* Compact Lot Info Card */
      .lot-info-compact {
        background-color: var(--color-light-gray);
        border: 1px solid var(--color-light-gray);
        border-radius: var(--radius-md);
        padding: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
      }
      
      .lot-info-title {
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-xs);
        color: var(--color-green-primary);
        margin-bottom: var(--spacing-xs);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }
      
      .lot-info-grid-compact {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-xs);
      }
      
      .lot-info-item-compact {
        text-align: left;
      }
      
      .lot-info-label-compact {
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-medium);
        font-size: var(--font-size-xs);
        color: var(--color-dark-gray);
        margin-bottom: 2px;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
      }
      
      .lot-info-value-compact {
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-xs);
        color: var(--color-primary-dark);
        line-height: var(--line-height-snug);
      }
      
      /* Compact Form Sections */
      .form-section {
        margin-bottom: var(--spacing-md);
      }
      
      .form-section-title {
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-xs);
        color: var(--color-green-primary);
        margin-bottom: var(--spacing-xs);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }
      
      .form-section-icon {
        font-size: var(--font-size-base);
        opacity: 0.8;
      }
      
      /* Compact Form Fields */
      .form-group {
        margin-bottom: var(--spacing-sm);
      }
      
      .form-group-double {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-sm);
      }
      
      .form-label {
        display: block;
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-medium);
        font-size: var(--font-size-sm);
        color: var(--color-primary-dark);
        margin-bottom: var(--spacing-xs);
        line-height: var(--line-height-normal);
      }
      
      .form-label--required::after {
        content: ' *';
        color: var(--color-red-accent);
        font-weight: var(--font-weight-bold);
      }
      
      .form-input,
      .form-textarea {
        width: 100%;
        padding: var(--spacing-xs) var(--spacing-sm);
        border: 2px solid var(--color-light-gray);
        border-radius: var(--radius-sm);
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-normal);
        color: var(--color-primary-dark);
        background-color: var(--color-white);
        transition: all var(--transition-fast);
        box-sizing: border-box;
      }
      
      .form-input:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--color-green-primary);
        background-color: rgba(255, 248, 246, 0.5);
      }
      
      .form-input:invalid:not(:focus):not(:placeholder-shown),
      .form-textarea:invalid:not(:focus):not(:placeholder-shown) {
        border-color: var(--color-red-accent);
        background-color: rgba(235, 102, 78, 0.05);
      }
      
      .form-input:valid:not(:focus):not(:placeholder-shown),
      .form-textarea:valid:not(:focus):not(:placeholder-shown) {
        border-color: var(--color-green-primary);
        background-color: rgba(31, 75, 67, 0.05);
      }
      
      .form-textarea {
        resize: vertical;
        min-height: 60px;
        line-height: var(--line-height-normal);
      }

      /* Phone Input Group */
      .phone-input-group {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: var(--spacing-xs);
        position: relative; /* Contexto de posicionamiento para el dropdown */
      }

      .phone-country-code {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: var(--color-white);
        border: 2px solid var(--color-light-gray);
        border-radius: var(--radius-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--color-primary-dark);
        cursor: pointer;
        transition: all var(--transition-fast);
        box-sizing: border-box;
      }

      .phone-country-code:hover {
        border-color: var(--color-green-primary);
        background-color: rgba(255, 248, 246, 0.5);
      }

      .phone-country-code:focus {
        outline: none;
        border-color: var(--color-green-primary);
        background-color: rgba(255, 248, 246, 0.5);
      }

      .phone-number-input {
        flex: 1;
      }

      /* Custom Country Dropdown */
      .country-dropdown {
        position: relative;
        width: 100%;
        z-index: 10; /* Por encima del contenido del formulario */
      }

      .country-trigger {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: var(--color-white);
        border: 2px solid var(--color-light-gray);
        border-radius: var(--radius-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--color-primary-dark);
        cursor: pointer;
        transition: all var(--transition-fast);
        box-sizing: border-box;
        width: 100%;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .country-trigger:hover {
        border-color: var(--color-green-primary);
        background-color: rgba(255, 248, 246, 0.5);
      }

      .country-trigger:focus {
        outline: none;
        border-color: var(--color-green-primary);
        background-color: rgba(255, 248, 246, 0.5);
      }

      .country-trigger[aria-expanded="true"] {
        border-color: var(--color-green-primary);
        background-color: rgba(255, 248, 246, 0.5);
      }

      .country-flag {
        width: 20px;
        height: 15px;
        object-fit: cover;
        border-radius: 2px;
        flex-shrink: 0;
      }

      .country-iso {
        display: none !important; /* Ocultar c√≥digo ISO siempre - solo mostrar bandera + dial */
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--color-primary-dark);
        flex-shrink: 0;
      }

      .country-dial {
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--color-primary-dark);
        flex-shrink: 0;
      }

      .country-chevron {
        margin-left: auto;
        flex-shrink: 0;
        transition: transform var(--transition-fast);
      }

      .country-trigger[aria-expanded="true"] .country-chevron {
        transform: rotate(180deg);
      }

      .country-popover {
        position: absolute;
        top: calc(100% + 8px);
        bottom: auto;
        left: 0;
        width: 280px;
        height: min(70vh, 360px); /* Altura FIJA para evitar que empuje elementos */
        background-color: var(--color-white);
        border: 2px solid var(--color-light-gray);
        border-radius: var(--radius-sm);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 5000; /* Por encima del mapa Leaflet */
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Contenedor sin scroll */
        margin: 0 !important; /* Evitar margin que interfiera con posicionamiento */
      }

      .country-popover[hidden] {
        display: none;
      }

      /* Clase para cuando el popover est√° "portaleado" al body en desktop */
      .country-popover.portaled {
        position: fixed !important;
        /* Top y left ser√°n calculados por JavaScript */
      }

      .country-search-wrapper {
        padding: var(--spacing-xs);
        border-bottom: 1px solid var(--color-light-gray);
        flex-shrink: 0;
      }

      .country-search {
        width: 100%;
        padding: var(--spacing-xs);
        border: 1px solid var(--color-light-gray);
        border-radius: var(--radius-sm);
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        color: var(--color-primary-dark);
        box-sizing: border-box;
      }

      .country-search:focus {
        outline: none;
        border-color: var(--color-green-primary);
      }

      .country-list {
        overflow-y: auto;
        flex: 1;
        min-height: 0; /* CR√çTICO: permite que flex calcule correctamente el scroll */
      }

      .country-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: var(--spacing-xs) var(--spacing-sm);
        cursor: pointer;
        transition: background-color var(--transition-fast);
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
      }

      .country-option:hover {
        background-color: rgba(255, 248, 246, 0.8);
      }

      .country-option:focus {
        outline: none;
        background-color: rgba(255, 248, 246, 0.8);
      }

      .country-option.selected {
        background-color: rgba(46, 125, 50, 0.1);
      }

      .country-option-name {
        flex: 1;
        color: var(--color-primary-dark);
        font-weight: var(--font-weight-regular);
      }

      .country-option-dial {
        color: var(--color-dark-gray);
        font-size: var(--font-size-xs);
        flex-shrink: 0;
      }

      /* Submit Button */
      .form-actions {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--color-light-gray);
        display: flex;
        justify-content: center;
      }
      
      .submit-btn {
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-xs);
        line-height: var(--line-height-normal);
        letter-spacing: var(--letter-spacing-wide);
        text-transform: uppercase;
        color: var(--color-white);
        background-color: var(--color-green-primary);
        border: 2px solid var(--color-green-primary);
        border-radius: var(--radius-md);
        padding: var(--spacing-xs) var(--spacing-md);
        cursor: pointer;
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
        width: auto;
        min-width: 200px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
      }
      
      .submit-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background-color: var(--color-dark-blue);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: all var(--transition-normal);
        z-index: -1;
      }
      
      .submit-btn:hover::before {
        width: 300px;
        height: 300px;
      }
      
      .submit-btn:hover {
        border-color: var(--color-dark-blue);
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(31, 75, 67, 0.3);
      }
      
      .submit-btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(31, 75, 67, 0.3);
      }
      
      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .submit-btn:disabled:hover {
        transform: none;
        box-shadow: var(--shadow-md);
      }
      
      /* Button States */
      .btn-loading .btn-text {
        opacity: 0;
      }
      
      .btn-loading .btn-spinner {
        display: block;
      }
      
      .btn-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid var(--color-white);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Success/Error Messages */
      .form-message {
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-medium);
        text-align: center;
        display: none;
      }
      
      .form-message--success {
        background-color: rgba(31, 75, 67, 0.1);
        border: 1px solid var(--color-green-primary);
        color: var(--color-green-primary);
      }
      
      .form-message--error {
        background-color: rgba(235, 102, 78, 0.1);
        border: 1px solid var(--color-red-accent);
        color: var(--color-red-accent);
      }
      
      /* Field Validation Messages */
      .field-error {
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        color: var(--color-red-accent);
        margin-top: var(--spacing-xs);
        display: none;
      }
      
      .field-error.show {
        display: block;
      }
      
      /* Field Help Text */
      .field-help {
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        color: var(--color-dark-gray);
        margin-top: var(--spacing-xs);
        display: block;
      }
      
      /* Map Marker Styling */
      .leaflet-marker-icon.lot-marker {
        background-color: var(--color-red-accent);
        border: 3px solid var(--color-white);
        border-radius: 50%;
        box-shadow: var(--shadow-md);
      }
      
      /* Responsive Design */
      @media (max-width: 768px) {
        .reservation-top-bar {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--spacing-sm);
          margin-bottom: var(--spacing-sm);
        }

        .language-selector-wrapper {
          width: 100%;
        }

        .language-selector {
          width: 100%;
        }

        .reservation-layout {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr;
          gap: 0;
          height: auto;
          min-height: 100vh;
        }

        .form-column {
          padding: var(--spacing-md);
          max-height: none;
          overflow-y: visible;
        }

        .map-column {
          display: none;
        }

        .form-group-double {
          grid-template-columns: 1fr;
          gap: var(--spacing-md);
        }

        .lot-info-grid-compact {
          grid-template-columns: repeat(2, 1fr);
          gap: var(--spacing-xs);
        }

        .lot-info-item-compact {
          text-align: left;
        }

        .form-section-title {
          font-size: var(--font-size-xs);
        }

        .reservation-title {
          font-size: var(--font-size-base);
        }

        .back-link {
          font-size: var(--font-size-xs);
        }

        .form-input,
        .form-textarea {
          font-size: var(--font-size-xs);
        }

        .form-textarea {
          min-height: 50px;
        }

        .phone-input-group {
          grid-template-columns: 100px 1fr;
        }

        /* Mobile Country Dropdown Adjustments */
        .country-trigger {
          padding: var(--spacing-xs) 6px;
          gap: 4px;
        }

        .country-iso {
          display: none !important; /* Hide ISO code on mobile */
        }

        .country-popover {
          position: fixed !important; /* Modal fijo desde abajo */
          top: auto;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100vw;
          max-width: none;
          height: 60vh;
          max-height: 60vh;
          border-radius: var(--radius-sm) var(--radius-sm) 0 0;
          transform: none;
          box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
        }
      }

      @media (max-width: 480px) {
        .reservation-container {
          padding: var(--spacing-sm) 0;
        }

        .reservation-wrapper {
          padding: 0 var(--spacing-sm);
        }

        .reservation-top-bar {
          margin-bottom: var(--spacing-xs);
        }

        .back-link {
          font-size: 0.65rem;
        }

        .language-selector {
          font-size: 0.65rem;
          padding: 6px var(--spacing-md) 6px var(--spacing-xs);
        }

        .form-column {
          padding: var(--spacing-sm);
        }

        .reservation-header {
          margin-bottom: var(--spacing-sm);
          padding-bottom: var(--spacing-xs);
        }

        .reservation-title {
          font-size: var(--font-size-sm);
        }

        .reservation-subtitle {
          font-size: var(--font-size-xs);
        }

        .lot-info-compact {
          margin-bottom: var(--spacing-sm);
        }

        .form-section {
          margin-bottom: var(--spacing-md);
        }

        .form-input,
        .form-textarea {
          padding: var(--spacing-xs);
          font-size: var(--font-size-xs);
        }

        .form-textarea {
          min-height: 40px;
        }

        .submit-btn {
          font-size: var(--font-size-xs);
          padding: var(--spacing-xs) var(--spacing-sm);
        }
      }
      
      /* Accessibility */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
        
        .submit-btn:hover {
          transform: none;
        }
        
        .back-link:hover {
          transform: none;
        }
        
        .btn-spinner {
          animation: none;
        }
      }
      
      /* Toast Component Styles */
      .toast-container {
        position: fixed;
        top: var(--spacing-lg);
        right: var(--spacing-lg);
        z-index: 1050;
        max-width: 350px;
        pointer-events: none;
      }
      
      .toast {
        background-color: var(--color-white);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--color-light-gray);
        margin-bottom: var(--spacing-sm);
        pointer-events: auto;
        opacity: 0;
        transform: translateX(100%);
        transition: all var(--transition-normal);
        overflow: hidden;
        max-width: 100%;
      }
      
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      
      .toast-header {
        display: flex;
        align-items: center;
        padding: var(--spacing-xs) var(--spacing-sm);
        background-color: var(--color-light-gray);
        border-bottom: 1px solid var(--color-light-gray);
      }
      
      .toast-success .toast-header {
        background-color: rgba(31, 75, 67, 0.1);
        border-bottom-color: var(--color-green-primary);
        color: var(--color-green-primary);
      }
      
      .toast-error .toast-header {
        background-color: rgba(235, 102, 78, 0.1);
        border-bottom-color: var(--color-red-accent);
        color: var(--color-red-accent);
      }
      
      .toast-title {
        font-family: var(--font-family-primary);
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-xs);
        margin: 0;
        flex: 1;
      }
      
      .toast-close {
        background: none;
        border: none;
        font-size: var(--font-size-sm);
        cursor: pointer;
        padding: 0;
        margin-left: var(--spacing-xs);
        color: inherit;
        opacity: 0.7;
        transition: opacity var(--transition-fast);
      }
      
      .toast-close:hover {
        opacity: 1;
      }
      
      .toast-body {
        padding: var(--spacing-sm);
        font-family: var(--font-family-primary);
        font-size: var(--font-size-xs);
        color: var(--color-dark-gray);
        line-height: var(--line-height-normal);
      }
      
      @media (max-width: 768px) {
        .toast-container {
          top: var(--spacing-sm);
          right: var(--spacing-sm);
          left: var(--spacing-sm);
          max-width: none;
        }
        
        .toast {
          transform: translateY(-100%);
        }
        
        .toast.show {
          transform: translateY(0);
        }
      }

      /* Focus management for better accessibility */
      .form-input:focus-visible,
      .form-textarea:focus-visible {
        outline: none;
      }
      
      .submit-btn:focus-visible {
        outline: 2px solid var(--color-green-primary);
        outline-offset: 2px;
      }
    </style>
  </head>
  
  <body>
    <div class="reservation-container">
      <div class="reservation-wrapper">
        <!-- Header with Language Selector -->
        <div class="reservation-top-bar">
          <!-- Back to Map Link -->
          <a href="mapa.html" class="back-link" data-i18n-attr="aria-label:reservation.back_link" aria-label="Volver al mapa">
            <span class="back-arrow">‚Üê</span>
            <span data-i18n="reservation.back_link">Volver al mapa</span>
          </a>

          <!-- Language Selector -->
          <div class="language-selector-wrapper">
            <select
              id="language-selector"
              class="language-selector"
              aria-label="Seleccionar idioma / Select language / Sprache w√§hlen"
            >
              <option value="es" data-flag="üá™üá∏" selected>üá™üá∏</option>
              <option value="en" data-flag="üá∫üá∏">üá∫üá∏</option>
              <option value="de" data-flag="üá©üá™">üá©üá™</option>
            </select>
          </div>
        </div>
        
        <!-- New Layout Grid -->
        <div class="reservation-layout">
          <!-- Form Column -->
          <div class="form-column">
            <header class="reservation-header" role="banner">
              <h1 class="reservation-title" data-i18n="reservation.header.title">Formulario de Reservaci√≥n</h1>
              <p class="reservation-subtitle" data-i18n="reservation.header.subtitle">
                Complete la informaci√≥n para reservar su lote. Nos contactaremos con usted en 24 horas.
              </p>
            </header>

            <!-- Compact Lot Information -->
            <div class="lot-info-compact">
              <div class="lot-info-grid-compact">
                <div class="lot-info-item-compact">
                  <div class="lot-info-label-compact" data-i18n="reservation.lot_info.id">ID del Lote</div>
                  <div id="lotId" class="lot-info-value-compact">No especificado</div>
                </div>
                <div class="lot-info-item-compact">
                  <div class="lot-info-label-compact" data-i18n="reservation.lot_info.price">Precio</div>
                  <div id="lotPrice" class="lot-info-value-compact">Consultar</div>
                </div>
                <div class="lot-info-item-compact">
                  <div class="lot-info-label-compact" data-i18n="reservation.lot_info.dimensions">Dimensiones</div>
                  <div id="lotDimensions" class="lot-info-value-compact">No especificadas</div>
                </div>
                <div class="lot-info-item-compact">
                  <div class="lot-info-label-compact" data-i18n="reservation.lot_info.area">√Årea (m¬≤)</div>
                  <div id="lotArea" class="lot-info-value-compact">N/A</div>
                </div>
              </div>
            </div>
            
            
            <form id="reservationForm" class="reservation-form" novalidate>
              <!-- Personal Information Section -->
              <section class="form-section" aria-labelledby="personal-info-title">
                <h2 id="personal-info-title" class="form-section-title">
                  <span data-i18n="reservation.form.personal_info.title">Informaci√≥n Personal</span>
                </h2>

                <div class="form-group-double">
                  <div class="form-group">
                    <input
                      type="text"
                      id="firstName"
                      name="firstName"
                      class="form-input"
                      required
                      autocomplete="given-name"
                      data-i18n-attr="placeholder:reservation.form.personal_info.first_name"
                      placeholder="Nombre *"
                      aria-describedby="firstName-error"
                    />
                    <div id="firstName-error" class="field-error"></div>
                  </div>

                  <div class="form-group">
                    <input
                      type="text"
                      id="lastName"
                      name="lastName"
                      class="form-input"
                      required
                      autocomplete="family-name"
                      data-i18n-attr="placeholder:reservation.form.personal_info.last_name"
                      placeholder="Apellido *"
                      aria-describedby="lastName-error"
                    />
                    <div id="lastName-error" class="field-error"></div>
                  </div>
                </div>

                <div class="form-group-double">
                  <div class="form-group">
                    <input
                      type="email"
                      id="email"
                      name="email"
                      class="form-input"
                      required
                      autocomplete="email"
                      data-i18n-attr="placeholder:reservation.form.personal_info.email"
                      placeholder="Correo Electr√≥nico *"
                      aria-describedby="email-error"
                    />
                    <div id="email-error" class="field-error"></div>
                  </div>

                  <div class="form-group">
                    <div class="phone-input-group">
                      <!-- Custom Country Dropdown -->
                      <div class="country-dropdown" id="countryDropdown">
                        <button type="button" class="country-trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Seleccionar c√≥digo de pa√≠s">
                          <img src="https://flagcdn.com/w20/py.png" alt="PY" class="country-flag" id="selectedFlag">
                          <span class="country-iso" id="selectedIso">PY</span>
                          <span class="country-dial" id="selectedDial">+595</span>
                          <svg class="country-chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                          </svg>
                        </button>

                        <div class="country-popover" hidden>
                          <div class="country-search-wrapper">
                            <input type="text" class="country-search" data-i18n-attr="placeholder:reservation.form.personal_info.country_search,aria-label:reservation.form.personal_info.country_search" placeholder="" aria-label="Buscar">
                          </div>
                          <div class="country-list" role="listbox"></div>
                        </div>

                        <input type="hidden" id="countryCode" name="countryCode" value="+595">
                        <input type="hidden" id="countryIso2" name="countryIso2" value="PY">
                      </div>
                      <input
                        type="tel"
                        id="phone"
                        name="phone"
                        class="form-input phone-number-input"
                        required
                        autocomplete="tel"
                        data-i18n-attr="placeholder:reservation.form.personal_info.phone"
                        placeholder="Tel√©fono *"
                        aria-describedby="phone-error"
                      />
                    </div>
                    <div id="phone-error" class="field-error"></div>
                  </div>
                </div>
              </section>

              <!-- Additional Message Section - Integrated -->
              <div class="form-group" style="margin-top: var(--spacing-xs);">
                <textarea
                  id="additionalMessage"
                  name="additionalMessage"
                  class="form-textarea"
                  data-i18n-attr="placeholder:reservation.form.additional_message.placeholder"
                  placeholder="Mensaje adicional (opcional)"
                  aria-describedby="message-help"
                ></textarea>
                <small id="message-help" class="field-help" data-i18n="reservation.form.additional_message.help">
                  M√°ximo 500 caracteres.
                </small>
              </div>

              <!-- Submit Actions -->
              <div class="form-actions">
                <button type="submit" id="submitBtn" class="submit-btn">
                  <span class="btn-text" data-i18n="reservation.form.submit">Enviar Reservaci√≥n</span>
                  <div class="btn-spinner" aria-hidden="true"></div>
                </button>
              </div>
            </form>
          </div>
          
          <!-- Map Column -->
          <div class="map-column">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Internationalization -->
    <script src="assets/js/i18n.js"></script>

    <!-- Supabase Services -->
    <script src="assets/js/supabase-client.js"></script>
    <script src="assets/js/loteamiento-service.js"></script>
    <script src="assets/js/lote-service.js"></script>

    <!-- Reservation API Configuration (must load before reservation-service.js) -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/reservation-service.js"></script>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      // Reservation Form JavaScript with Leaflet Integration
      
      // DOM Elements
      const form = document.getElementById('reservationForm');
      const submitBtn = document.getElementById('submitBtn');
      const toastContainer = document.getElementById('toastContainer');
      
      // Form fields
      const firstName = document.getElementById('firstName');
      const lastName = document.getElementById('lastName');
      const email = document.getElementById('email');
      const phone = document.getElementById('phone');
      const countryCodeSelect = document.getElementById('countryCode');
      const additionalMessage = document.getElementById('additionalMessage');

      // Track if user manually changed country code (to avoid overriding their choice)
      let userModifiedCountryCode = false;
      
      // Lot information elements
      const lotIdElement = document.getElementById('lotId');
      const lotPriceElement = document.getElementById('lotPrice');
      const lotDimensionsElement = document.getElementById('lotDimensions');
      const lotAreaElement = document.getElementById('lotArea');
      
      // Map variables
      let map;
      let lotMarker;

      // Current lote data (populated during initialization)
      let currentLoteData = null;
      
      // Toast Management System
      function createToast(type, title, message, duration = 5000) {
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.id = toastId;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        const closeLabel = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
          ? window.i18n.t('reservation.toast.close')
          : 'Cerrar';
        toast.innerHTML = `
          <div class="toast-header">
            <strong class="toast-title">${title}</strong>
            <button type="button" class="toast-close" aria-label="${closeLabel}">√ó</button>
          </div>
          <div class="toast-body">${message}</div>
        `;
        
        // Add close functionality
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', () => {
          hideToast(toastId);
        });
        
        // Add to container
        toastContainer.appendChild(toast);
        
        // Show toast with animation
        setTimeout(() => {
          toast.classList.add('show');
        }, 100);
        
        // Auto-hide after duration
        if (duration > 0) {
          setTimeout(() => {
            hideToast(toastId);
          }, duration);
        }
        
        return toastId;
      }
      
      function hideToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
          toast.classList.remove('show');
          toast.classList.add('hide');
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }
      }
      
      function showSuccess(message) {
        const title = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
          ? window.i18n.t('reservation.toast.success_title')
          : '¬°√âxito!';
        createToast('success', title, message, 5000);
      }

      function showError(message) {
        const title = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
          ? window.i18n.t('reservation.toast.error_title')
          : 'Error';
        createToast('error', title, message, 7000);
      }

      /**
       * Auto-detect and set country code based on current language
       * @param {string} lang - Current language code ('es', 'en', 'de')
       */
      function autoDetectCountryCode(lang) {
        // Don't override if user manually changed it
        if (userModifiedCountryCode) {
          console.log('‚úì Country code not changed (user manually selected)');
          return;
        }

        const countryCodeMap = {
          'es': '+595',  // Paraguay
          'de': '+49',   // Alemania
          'en': '+1'     // USA
        };

        const defaultCode = countryCodeMap[lang] || '+595';

        if (countryCodeSelect && countryCodeSelect.value !== defaultCode) {
          countryCodeSelect.value = defaultCode;
          console.log(`‚úì Country code auto-set to ${defaultCode} based on language: ${lang}`);
        }
      }

      // URL Parameters Handler - Simplified for database-based approach
      function getURLParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
          lote_id: urlParams.get('lote_id'),
          loteamiento_id: urlParams.get('loteamiento_id')
        };
      }
      
      // Render lote polygon on map
      function renderLoteOnMap(loteData) {
        if (!map || !loteData) return;

        // Clear existing marker if any
        if (lotMarker) {
          map.removeLayer(lotMarker);
          lotMarker = null;
        }

        // Render parcel polygon from GeoJSON feature
        if (loteData.feature) {
          try {
            // Get color based on estado
            let fillColor = '#28a745'; // disponible (green)
            const estado = (loteData.estado || '').toLowerCase();
            if (estado.includes('reservado')) {
              fillColor = '#ffc107'; // reservado (yellow)
            } else if (estado.includes('no_disponible') || estado.includes('vendido')) {
              fillColor = '#dc3545'; // vendido (red)
            }

            // Render parcel polygon
            const parcelLayer = L.geoJSON(loteData.feature, {
              style: {
                color: '#1F4B43',
                weight: 3,
                opacity: 0.9,
                fillColor: fillColor,
                fillOpacity: 0.5
              }
            }).addTo(map);

            // Fit map to parcel bounds
            map.fitBounds(parcelLayer.getBounds(), {
              padding: [50, 50],
              maxZoom: 19
            });

            // Add popup
            parcelLayer.bindPopup(`
              <div style="text-align: center; font-family: var(--font-family-primary);">
                <strong style="color: var(--color-green-primary);">${loteData.nombre || loteData.name}</strong><br>
                <small style="color: var(--color-dark-gray);">Colonia Independencia</small><br>
                <small style="color: var(--color-dark-gray);">${loteData.lados || 'Ver dimensiones arriba'}</small>
              </div>
            `);

            console.log('‚úì Rendered parcel polygon from database');
          } catch (e) {
            console.error('Error rendering parcel polygon:', e);
          }
        }

        // Handle map resize
        setTimeout(() => {
          map.invalidateSize();
        }, 250);
      }

      /**
       * Format price in European EUR format
       * @param {number} price - Price value
       * @returns {string} Formatted price (e.g., "160.705,65 ‚Ç¨")
       */
      function formatEuroPrice(price) {
        if (!price || price === 0) return 'Consultar';

        // Convert to number if string
        const numPrice = typeof price === 'number' ? price : parseFloat(price);

        // Format with 2 decimal places
        const priceStr = numPrice.toFixed(2);

        // Split integer and decimal parts
        const [integerPart, decimalPart] = priceStr.split('.');

        // Add thousands separator (dot)
        const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Return with European format: dot for thousands, comma for decimals, ‚Ç¨ at end
        return `${formattedInteger},${decimalPart} ‚Ç¨`;
      }

      // Populate lot information from lote data
      function populateLotInformation(loteData) {
        if (!loteData) return;

        // Set lote name
        const loteName = loteData.nombre || loteData.name || 'Lote';
        if (lotIdElement) {
          lotIdElement.textContent = loteName;
        }
        document.title = `Reservaci√≥n ${loteName} - Mega Proyectos`;

        // Set price (always show static localized "Consultar" text)
        if (lotPriceElement) {
          const consultText = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
            ? window.i18n.t('reservation.lot_info.consult')
            : 'Consultar';
          lotPriceElement.textContent = consultText;
        }

        // Set dimensions
        if (lotDimensionsElement) {
          const dimensions = loteData.lados || loteData.dimensions;
          if (dimensions) {
            lotDimensionsElement.textContent = dimensions;
          } else {
            lotDimensionsElement.textContent = 'Consultar';
          }
        }

        // Set area
        if (lotAreaElement) {
          const area = loteData.area_m2_rounded || loteData.area;
          if (area && area !== 0) {
            // Get current language for number formatting
            const currentLang = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
              ? window.i18n.getCurrentLanguage()
              : 'es';
            const localeMap = { 'es': 'es-PY', 'en': 'en-US', 'de': 'de-DE' };
            const formattedArea = area.toLocaleString(localeMap[currentLang]) + ' m¬≤';
            lotAreaElement.textContent = formattedArea;
          } else {
            lotAreaElement.textContent = 'N/A';
          }
        }
      }

      // Initialize map (called before data fetch)
      function initializeMap() {
        // Initialize map with default view
        map = L.map('map', {
          zoomControl: true,
          scrollWheelZoom: true,
          dragging: true,
          doubleClickZoom: true
        }).setView([-25.695804, -56.174242], 16);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 20,
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
      }

      // Update back link to preserve loteamiento context
      function updateBackLink(loteamientoId, loteamientoData) {
        const backLink = document.querySelector('.back-link');
        if (!backLink || !loteamientoData) return;

        // Build URL with loteamiento parameters so map loads correctly
        const mapUrl = new URLSearchParams({
          loteamiento: loteamientoId,
          name: loteamientoData.name || loteamientoData.nombre || 'Loteamiento',
          lat: loteamientoData.centroid_lat || loteamientoData.lat || -25.695804,
          lng: loteamientoData.centroid_long || loteamientoData.lng || -56.174242
        });

        backLink.href = `mapa.html?${mapUrl.toString()}`;
        console.log('‚úì Updated back link with loteamiento context');
      }

      // Fetch lote data from database and initialize form
      async function initializeReservationForm() {
        const params = getURLParameters();

        // Validate URL parameters
        if (!params.lote_id || !params.loteamiento_id) {
          const errorMsg = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
            ? window.i18n.t('reservation.errors.invalid_params')
            : 'Error: Par√°metros de URL inv√°lidos. Por favor, seleccione un lote desde el mapa.';
          showError(errorMsg);
          console.error('Missing URL parameters:', params);
          return;
        }

        try {
          // Show loading state (optional - could add a spinner here)
          console.log(`Loading lote data for ID: ${params.lote_id}...`);

          // Initialize Supabase client and service
          if (!window.SupabaseClient || !window.SupabaseClient.isReady()) {
            await window.SupabaseClient.initialize();
          }

          if (!window.LoteService) {
            window.LoteService = new LoteService();
          }

          if (!window.LoteamientoService) {
            window.LoteamientoService = new LoteamientoService();
          }

          // Fetch lote data from database
          const loteData = await window.LoteService.fetchById(params.lote_id);

          if (!loteData) {
            const errorMsg = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
              ? window.i18n.t('reservation.errors.lot_not_found')
              : 'Error: No se encontr√≥ el lote solicitado. Por favor, intente nuevamente.';
            showError(errorMsg);
            console.error('Lote not found for ID:', params.lote_id);
            return;
          }

          console.log('‚úì Lote data loaded:', loteData);

          // Store lote data globally for form submission
          currentLoteData = loteData;

          // Fetch loteamiento data to build proper back link
          const loteamientoData = await window.LoteamientoService.fetchById(params.loteamiento_id);
          if (loteamientoData) {
            updateBackLink(params.loteamiento_id, loteamientoData);
          }

          // Populate form with fetched data
          populateLotInformation(loteData);

          // Render lote on map
          renderLoteOnMap(loteData);

        } catch (error) {
          console.error('Error loading lote data:', error);
          const errorMsg = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
            ? window.i18n.t('reservation.errors.loading_error')
            : 'Error al cargar los datos del lote. Por favor, intente nuevamente.';
          showError(errorMsg);
        }
      }
      
      /**
       * Clean and format phone number
       * Removes leading zero and non-digit characters
       * @param {string} phoneNumber - Raw phone number input
       * @param {string} countryCode - Selected country code
       * @returns {Object} { cleaned: string, isValid: boolean }
       */
      function cleanPhoneNumber(phoneNumber, countryCode) {
        // Remove all non-digit characters
        let cleaned = phoneNumber.replace(/\D/g, '');

        // Remove leading zero (common in local formats like Paraguay 0983...)
        if (cleaned.startsWith('0')) {
          cleaned = cleaned.substring(1);
        }

        // Validation rules by country code (comprehensive list)
        const validationRules = {
          // Americas
          '+1': { minLength: 10, maxLength: 10 }, // USA/Canada/Caribbean
          '+52': { minLength: 10, maxLength: 10 }, // M√©xico
          '+54': { minLength: 10, maxLength: 10 }, // Argentina
          '+55': { minLength: 10, maxLength: 11 }, // Brasil
          '+56': { minLength: 9, maxLength: 9 }, // Chile
          '+57': { minLength: 10, maxLength: 10 }, // Colombia
          '+58': { minLength: 10, maxLength: 10 }, // Venezuela
          '+51': { minLength: 9, maxLength: 9 }, // Per√∫
          '+591': { minLength: 8, maxLength: 8 }, // Bolivia
          '+593': { minLength: 9, maxLength: 9 }, // Ecuador
          '+595': { minLength: 9, maxLength: 9 }, // Paraguay
          '+598': { minLength: 8, maxLength: 8 }, // Uruguay
          '+506': { minLength: 8, maxLength: 8 }, // Costa Rica
          '+503': { minLength: 8, maxLength: 8 }, // El Salvador
          '+502': { minLength: 8, maxLength: 8 }, // Guatemala
          '+504': { minLength: 8, maxLength: 8 }, // Honduras
          '+505': { minLength: 8, maxLength: 8 }, // Nicaragua
          '+507': { minLength: 8, maxLength: 8 }, // Panam√°
          '+509': { minLength: 8, maxLength: 8 }, // Hait√≠
          '+53': { minLength: 8, maxLength: 8 }, // Cuba
          '+1809': { minLength: 10, maxLength: 10 }, // Rep√∫blica Dominicana
          '+1787': { minLength: 10, maxLength: 10 }, // Puerto Rico

          // Europe
          '+33': { minLength: 9, maxLength: 9 }, // Francia
          '+34': { minLength: 9, maxLength: 9 }, // Espa√±a
          '+39': { minLength: 9, maxLength: 10 }, // Italia
          '+44': { minLength: 10, maxLength: 10 }, // Reino Unido
          '+49': { minLength: 10, maxLength: 11 }, // Alemania
          '+31': { minLength: 9, maxLength: 9 }, // Pa√≠ses Bajos
          '+32': { minLength: 9, maxLength: 9 }, // B√©lgica
          '+41': { minLength: 9, maxLength: 9 }, // Suiza
          '+43': { minLength: 10, maxLength: 13 }, // Austria
          '+45': { minLength: 8, maxLength: 8 }, // Dinamarca
          '+46': { minLength: 9, maxLength: 9 }, // Suecia
          '+47': { minLength: 8, maxLength: 8 }, // Noruega
          '+48': { minLength: 9, maxLength: 9 }, // Polonia
          '+351': { minLength: 9, maxLength: 9 }, // Portugal
          '+353': { minLength: 9, maxLength: 9 }, // Irlanda
          '+358': { minLength: 9, maxLength: 10 }, // Finlandia
          '+30': { minLength: 10, maxLength: 10 }, // Grecia
          '+36': { minLength: 9, maxLength: 9 }, // Hungr√≠a
          '+40': { minLength: 9, maxLength: 9 }, // Rumania
          '+420': { minLength: 9, maxLength: 9 }, // Rep√∫blica Checa
          '+421': { minLength: 9, maxLength: 9 }, // Eslovaquia
          '+380': { minLength: 9, maxLength: 9 }, // Ucrania
          '+7': { minLength: 10, maxLength: 10 }, // Rusia/Kazajist√°n

          // Asia
          '+81': { minLength: 10, maxLength: 10 }, // Jap√≥n
          '+82': { minLength: 9, maxLength: 11 }, // Corea del Sur
          '+86': { minLength: 11, maxLength: 11 }, // China
          '+91': { minLength: 10, maxLength: 10 }, // India
          '+60': { minLength: 9, maxLength: 10 }, // Malasia
          '+62': { minLength: 9, maxLength: 12 }, // Indonesia
          '+63': { minLength: 10, maxLength: 10 }, // Filipinas
          '+65': { minLength: 8, maxLength: 8 }, // Singapur
          '+66': { minLength: 9, maxLength: 9 }, // Tailandia
          '+84': { minLength: 9, maxLength: 10 }, // Vietnam
          '+852': { minLength: 8, maxLength: 8 }, // Hong Kong
          '+853': { minLength: 8, maxLength: 8 }, // Macao
          '+886': { minLength: 9, maxLength: 9 }, // Taiw√°n
          '+92': { minLength: 10, maxLength: 10 }, // Pakist√°n
          '+94': { minLength: 9, maxLength: 9 }, // Sri Lanka
          '+95': { minLength: 8, maxLength: 10 }, // Myanmar
          '+98': { minLength: 10, maxLength: 10 }, // Ir√°n
          '+972': { minLength: 9, maxLength: 9 }, // Israel
          '+961': { minLength: 7, maxLength: 8 }, // L√≠bano
          '+962': { minLength: 9, maxLength: 9 }, // Jordania
          '+963': { minLength: 9, maxLength: 9 }, // Siria
          '+964': { minLength: 10, maxLength: 10 }, // Irak
          '+965': { minLength: 8, maxLength: 8 }, // Kuwait
          '+966': { minLength: 9, maxLength: 9 }, // Arabia Saudita
          '+967': { minLength: 9, maxLength: 9 }, // Yemen
          '+968': { minLength: 8, maxLength: 8 }, // Om√°n
          '+971': { minLength: 9, maxLength: 9 }, // Emiratos √Årabes
          '+973': { minLength: 8, maxLength: 8 }, // Bar√©in
          '+974': { minLength: 8, maxLength: 8 }, // Catar

          // Oceania
          '+61': { minLength: 9, maxLength: 9 }, // Australia
          '+64': { minLength: 8, maxLength: 10 }, // Nueva Zelanda
          '+679': { minLength: 7, maxLength: 7 }, // Fiyi
          '+675': { minLength: 8, maxLength: 8 }, // Pap√∫a Nueva Guinea

          // Africa
          '+27': { minLength: 9, maxLength: 9 }, // Sud√°frica
          '+20': { minLength: 10, maxLength: 10 }, // Egipto
          '+212': { minLength: 9, maxLength: 9 }, // Marruecos
          '+213': { minLength: 9, maxLength: 9 }, // Argelia
          '+216': { minLength: 8, maxLength: 8 }, // T√∫nez
          '+218': { minLength: 9, maxLength: 10 }, // Libia
          '+220': { minLength: 7, maxLength: 7 }, // Gambia
          '+221': { minLength: 9, maxLength: 9 }, // Senegal
          '+234': { minLength: 10, maxLength: 10 }, // Nigeria
          '+254': { minLength: 9, maxLength: 10 }, // Kenia
          '+255': { minLength: 9, maxLength: 9 }, // Tanzania
          '+256': { minLength: 9, maxLength: 9 }, // Uganda
          '+260': { minLength: 9, maxLength: 9 }, // Zambia
          '+263': { minLength: 9, maxLength: 9 }, // Zimbabue
        };

        const rules = validationRules[countryCode] || { minLength: 8, maxLength: 15 };
        const isValid = cleaned.length >= rules.minLength && cleaned.length <= rules.maxLength;

        return { cleaned, isValid };
      }

      // Form Validation
      function validateField(field, errorElement, validationRules) {
        const value = field.value.trim();
        let errorMessage = '';

        // Required field validation
        if (validationRules.required && !value) {
          errorMessage = getValidationMessage('required');
        }
        // Email validation
        else if (validationRules.email && value) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value)) {
            errorMessage = getValidationMessage('email_invalid');
          }
        }
        // Phone validation
        else if (validationRules.phone && value) {
          const countryCodeSelect = document.getElementById('countryCode');
          const countryCode = countryCodeSelect ? countryCodeSelect.value : '+595';

          const { cleaned, isValid } = cleanPhoneNumber(value, countryCode);

          if (!isValid) {
            errorMessage = getValidationMessage('phone_invalid');
          }
        }
        // Text length validation
        else if (validationRules.maxLength && value.length > validationRules.maxLength) {
          errorMessage = getValidationMessage('max_length', { max: validationRules.maxLength });
        }

        // Display error
        if (errorMessage) {
          errorElement.textContent = errorMessage;
          errorElement.classList.add('show');
          field.setAttribute('aria-invalid', 'true');
          return false;
        } else {
          errorElement.textContent = '';
          errorElement.classList.remove('show');
          field.setAttribute('aria-invalid', 'false');
          return true;
        }
      }
      
      // Real-time validation
      function setupRealTimeValidation() {
        firstName.addEventListener('blur', () => {
          validateField(firstName, document.getElementById('firstName-error'), { required: true });
        });

        lastName.addEventListener('blur', () => {
          validateField(lastName, document.getElementById('lastName-error'), { required: true });
        });

        email.addEventListener('blur', () => {
          validateField(email, document.getElementById('email-error'), { required: true, email: true });
        });

        phone.addEventListener('blur', () => {
          validateField(phone, document.getElementById('phone-error'), { required: true, phone: true });
        });

        // Revalidate phone number when country code changes
        const countryCodeSelect = document.getElementById('countryCode');
        if (countryCodeSelect) {
          countryCodeSelect.addEventListener('change', () => {
            if (phone.value.trim()) {
              validateField(phone, document.getElementById('phone-error'), { required: true, phone: true });
            }
          });
        }

        additionalMessage.addEventListener('input', () => {
          const charCount = additionalMessage.value.length;
          if (charCount > 500) {
            additionalMessage.value = additionalMessage.value.substring(0, 500);
          }
        });
      }
      
      // Form submission with ReservationService
      async function handleFormSubmission(event) {
        event.preventDefault();

        // Validate all fields
        const isFirstNameValid = validateField(firstName, document.getElementById('firstName-error'), { required: true });
        const isLastNameValid = validateField(lastName, document.getElementById('lastName-error'), { required: true });
        const isEmailValid = validateField(email, document.getElementById('email-error'), { required: true, email: true });
        const isPhoneValid = validateField(phone, document.getElementById('phone-error'), { required: true, phone: true });

        const isFormValid = isFirstNameValid && isLastNameValid && isEmailValid && isPhoneValid;

        if (!isFormValid) {
          showError(getValidationMessage('fix_errors'));

          // Focus on first invalid field
          const firstError = form.querySelector('.field-error.show');
          if (firstError) {
            const fieldId = firstError.id.replace('-error', '');
            document.getElementById(fieldId)?.focus();
          }
          return;
        }

        // Check if we have lote data
        if (!currentLoteData) {
          const errorMsg = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
            ? window.i18n.t('reservation.errors.no_lot_data')
            : 'Error: No se encontraron datos del lote. Por favor, recargue la p√°gina.';
          showError(errorMsg);
          console.error('currentLoteData is null');
          return;
        }

        // Get URL parameters for IDs
        const params = getURLParameters();
        if (!params.lote_id || !params.loteamiento_id) {
          const errorMsg = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
            ? window.i18n.t('reservation.errors.missing_params')
            : 'Error: Faltan par√°metros de URL. Por favor, seleccione un lote desde el mapa.';
          showError(errorMsg);
          return;
        }

        // Show loading state
        submitBtn.classList.add('btn-loading');
        submitBtn.disabled = true;

        // Get country code and clean phone number
        const countryCodeSelect = document.getElementById('countryCode');
        const countryCode = countryCodeSelect ? countryCodeSelect.value : '+595';
        const { cleaned } = cleanPhoneNumber(phone.value.trim(), countryCode);
        const fullPhoneNumber = `${countryCode}${cleaned}`;

        // Prepare reservation data
        const reservationData = {
          firstName: firstName.value.trim(),
          lastName: lastName.value.trim(),
          email: email.value.trim(),
          phone: fullPhoneNumber,
          additionalMessage: additionalMessage.value.trim() || null,
          loteId: params.lote_id,
          loteamientoId: params.loteamiento_id,
          lotDetails: {
            nombre: currentLoteData.nombre || currentLoteData.name,
            loteamiento_id: params.loteamiento_id,
            area_m2: currentLoteData.area_m2_rounded || currentLoteData.area,
            lados: currentLoteData.lados
          }
        };

        try {
          // Submit reservation using ReservationService
          const response = await window.ReservationService.submitReservation(reservationData);

          // Reset loading state
          submitBtn.classList.remove('btn-loading');
          submitBtn.disabled = false;

          // Handle response
          if (response.success) {
            // Show success message in current language
            const langSuffix = getCurrentLanguageSuffix();
            const successMessage = response[`message${langSuffix}`] || response.message_es || 'Reservaci√≥n enviada exitosamente.';
            showSuccess(successMessage);

            // Reset form
            form.reset();

            // Log success data
            console.log('‚úì Reservation created successfully:', response.data);

            // Optional: Redirect to confirmation page after 3 seconds
            // setTimeout(() => {
            //   window.location.href = 'index.html';
            // }, 3000);

          } else {
            // Show error message in current language
            const langSuffix = getCurrentLanguageSuffix();
            const errorMessage = response.error[`message${langSuffix}`] || response.error.message_es || 'Error al procesar la reservaci√≥n.';
            showError(errorMessage);

            // Log error details
            console.error('Reservation error:', response.error);

            // Handle specific error codes
            if (response.error.code === 'LOT_NOT_AVAILABLE') {
              // Optionally disable form or show special message
              setTimeout(() => {
                const notAvailableMsg = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
                  ? window.i18n.t('reservation.errors.lot_not_available')
                  : 'Este lote ya no est√° disponible. Redirigiendo al mapa...';
                showError(notAvailableMsg);
                setTimeout(() => {
                  window.history.back();
                }, 2000);
              }, 1500);
            }
          }

        } catch (error) {
          // Reset loading state
          submitBtn.classList.remove('btn-loading');
          submitBtn.disabled = false;

          // Show generic error
          const errorMsg = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
            ? window.i18n.t('reservation.errors.submission_error')
            : 'Error inesperado al enviar la reservaci√≥n. Por favor, intente nuevamente.';
          showError(errorMsg);
          console.error('Unexpected error in form submission:', error);
        }
      }
      
      // Initialize the form
      async function initializeForm() {
        // Initialize map first (shows base map while loading data)
        initializeMap();

        // Fetch lote data and populate form
        await initializeReservationForm();

        // Setup form validation and event handlers
        setupRealTimeValidation();
        form.addEventListener('submit', handleFormSubmission);

        // Handle responsive behavior
        window.addEventListener('resize', () => {
          setTimeout(() => {
            if (map) {
              map.invalidateSize();
            }
          }, 200);
        });

        // Focus management
        firstName.focus();

        // Accessibility enhancements
        document.addEventListener('keydown', (event) => {
          // ESC key to dismiss all toasts
          if (event.key === 'Escape') {
            const toasts = toastContainer.querySelectorAll('.toast.show');
            toasts.forEach(toast => {
              hideToast(toast.id);
            });
          }
        });
      }
      
      // ===========================
      // INTERNATIONALIZATION SUPPORT
      // ===========================

      /**
       * Initialize language selector and event handlers
       */
      function initializeLanguageSupport() {
        const languageSelector = document.getElementById('language-selector');

        if (languageSelector) {
          // Update selector on language change
          document.addEventListener('languageChanged', (e) => {
            const newLang = e.detail.language;
            if (languageSelector.value !== newLang) {
              languageSelector.value = newLang;
            }

            // Auto-detect country code based on new language
            autoDetectCountryCode(newLang);

            // Retranslate dynamic content
            retranslateDynamicContent(newLang);
          });

          // Handle selector changes
          languageSelector.addEventListener('change', (e) => {
            const selectedLang = e.target.value;
            if (window.i18n && window.i18n.setLanguage) {
              window.i18n.setLanguage(selectedLang);
            }
          });
        }

        // Track manual changes to country code
        if (countryCodeSelect) {
          countryCodeSelect.addEventListener('change', () => {
            userModifiedCountryCode = true;
            console.log('‚úì User manually changed country code');
          });
        }

        // Auto-detect country code on initial load
        const initialLang = (window.i18n && window.i18n.getCurrentLanguage)
          ? window.i18n.getCurrentLanguage()
          : 'es';
        autoDetectCountryCode(initialLang);
      }

      /**
       * Retranslate dynamic content that may have been set by JavaScript
       * @param {string} lang - Current language code
       */
      function retranslateDynamicContent(lang) {
        if (!window.i18n || !window.i18n.isInitialized || !window.i18n.isInitialized()) return;

        // Update toast close button if visible
        const toastCloseButtons = document.querySelectorAll('.toast-close');
        toastCloseButtons.forEach(btn => {
          btn.setAttribute('aria-label', window.i18n.t('reservation.toast.close'));
        });

        // Update submit button loading text
        if (submitBtn.classList.contains('btn-loading')) {
          const btnText = submitBtn.querySelector('.btn-text');
          if (btnText) {
            btnText.textContent = window.i18n.t('reservation.form.submitting');
          }
        }

        // Update dynamic lot info placeholders
        if (lotIdElement && lotIdElement.textContent === 'No especificado') {
          lotIdElement.textContent = window.i18n.t('reservation.lot_info.not_specified');
        }
        // Always update price text with localized "Consultar"
        if (lotPriceElement) {
          lotPriceElement.textContent = window.i18n.t('reservation.lot_info.consult');
        }
        if (lotDimensionsElement && lotDimensionsElement.textContent === 'No especificadas') {
          lotDimensionsElement.textContent = window.i18n.t('reservation.lot_info.not_specified');
        }

        // Reformat area with new language number formatting if we have lote data
        if (currentLoteData && lotAreaElement) {
          const area = currentLoteData.area_m2_rounded || currentLoteData.area;
          if (area && area !== 0) {
            const localeMap = { 'es': 'es-PY', 'en': 'en-US', 'de': 'de-DE' };
            const formattedArea = area.toLocaleString(localeMap[lang]) + ' m¬≤';
            lotAreaElement.textContent = formattedArea;
          }
        }

        // Update validation error messages with translations
        updateValidationMessages();
      }

      /**
       * Update validation error messages to use current language
       */
      function updateValidationMessages() {
        if (!window.i18n || !window.i18n.isInitialized || !window.i18n.isInitialized()) return;

        // Clear existing error messages and let them be regenerated on next validation
        const errorElements = document.querySelectorAll('.field-error.show');
        errorElements.forEach(el => {
          el.classList.remove('show');
          el.textContent = '';
        });
      }

      /**
       * Get current language suffix for message properties (e.g., 'message_es', 'message_en', 'message_de')
       * @returns {string} Language suffix
       */
      function getCurrentLanguageSuffix() {
        const currentLang = (window.i18n && window.i18n.isInitialized && window.i18n.isInitialized())
          ? window.i18n.getCurrentLanguage()
          : 'es';
        return `_${currentLang}`;
      }

      /**
       * Get localized validation message
       * @param {string} key - Validation message key
       * @param {Object} params - Parameters for interpolation
       * @returns {string} Localized message
       */
      function getValidationMessage(key, params = {}) {
        // Check if i18n is available and initialized
        if (!window.i18n || !window.i18n.isInitialized || !window.i18n.isInitialized()) {
          // Fallback messages in Spanish
          const fallbacks = {
            'required': 'Este campo es obligatorio.',
            'email_invalid': 'Por favor, ingrese un correo electr√≥nico v√°lido.',
            'phone_invalid': 'Por favor, ingrese un n√∫mero de tel√©fono v√°lido.',
            'max_length': `M√°ximo ${params.max} caracteres permitidos.`,
            'fix_errors': 'Por favor, corrija los errores marcados en el formulario.'
          };
          return fallbacks[key] || '';
        }

        const messageKey = `reservation.validation.${key}`;
        let message = window.i18n.t(messageKey);

        // If translation not found (returns key itself), use fallback
        if (message === messageKey) {
          const fallbacks = {
            'required': 'Este campo es obligatorio.',
            'email_invalid': 'Por favor, ingrese un correo electr√≥nico v√°lido.',
            'phone_invalid': 'Por favor, ingrese un n√∫mero de tel√©fono v√°lido.',
            'max_length': `M√°ximo ${params.max} caracteres permitidos.`,
            'fix_errors': 'Por favor, corrija los errores marcados en el formulario.'
          };
          message = fallbacks[key] || '';
        }

        // Replace placeholders
        Object.keys(params).forEach(param => {
          message = message.replace(`{{${param}}}`, params[param]);
        });

        return message;
      }

      // Initialize when DOM is loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          initializeLanguageSupport();
          initializeForm();
        });
      } else {
        initializeLanguageSupport();
        initializeForm();
      }

      // ===========================
      // CUSTOM COUNTRY DROPDOWN
      // ===========================
      (function initCountryDropdown() {
        'use strict';

        // All countries with flags (priority + alphabetical)
        const COUNTRIES = [
          // Priority countries
          { iso2: 'PY', name: 'Paraguay', dial: '+595', priority: true },
          { iso2: 'DE', name: 'Alemania', dial: '+49', priority: true },
          { iso2: 'NL', name: 'Pa√≠ses Bajos', dial: '+31', priority: true },
          { iso2: 'US', name: 'USA', dial: '+1', priority: true },

          // Alphabetical list
          { iso2: 'AF', name: 'Afganist√°n', dial: '+93' },
          { iso2: 'AL', name: 'Albania', dial: '+355' },
          { iso2: 'AD', name: 'Andorra', dial: '+376' },
          { iso2: 'AO', name: 'Angola', dial: '+244' },
          { iso2: 'AI', name: 'Anguila', dial: '+1264' },
          { iso2: 'AG', name: 'Antigua y Barbuda', dial: '+1268' },
          { iso2: 'SA', name: 'Arabia Saudita', dial: '+966' },
          { iso2: 'DZ', name: 'Argelia', dial: '+213' },
          { iso2: 'AR', name: 'Argentina', dial: '+54' },
          { iso2: 'AM', name: 'Armenia', dial: '+374' },
          { iso2: 'AW', name: 'Aruba', dial: '+297' },
          { iso2: 'AU', name: 'Australia', dial: '+61' },
          { iso2: 'AT', name: 'Austria', dial: '+43' },
          { iso2: 'AZ', name: 'Azerbaiy√°n', dial: '+994' },
          { iso2: 'BS', name: 'Bahamas', dial: '+1242' },
          { iso2: 'BD', name: 'Banglad√©s', dial: '+880' },
          { iso2: 'BB', name: 'Barbados', dial: '+1246' },
          { iso2: 'BH', name: 'Bar√©in', dial: '+973' },
          { iso2: 'BE', name: 'B√©lgica', dial: '+32' },
          { iso2: 'BZ', name: 'Belice', dial: '+501' },
          { iso2: 'BJ', name: 'Ben√≠n', dial: '+229' },
          { iso2: 'BM', name: 'Bermudas', dial: '+1441' },
          { iso2: 'BY', name: 'Bielorrusia', dial: '+375' },
          { iso2: 'BO', name: 'Bolivia', dial: '+591' },
          { iso2: 'BA', name: 'Bosnia-Herzegovina', dial: '+387' },
          { iso2: 'BW', name: 'Botsuana', dial: '+267' },
          { iso2: 'BR', name: 'Brasil', dial: '+55' },
          { iso2: 'BN', name: 'Brun√©i', dial: '+673' },
          { iso2: 'BG', name: 'Bulgaria', dial: '+359' },
          { iso2: 'BF', name: 'Burkina Faso', dial: '+226' },
          { iso2: 'BI', name: 'Burundi', dial: '+257' },
          { iso2: 'BT', name: 'But√°n', dial: '+975' },
          { iso2: 'CV', name: 'Cabo Verde', dial: '+238' },
          { iso2: 'KH', name: 'Camboya', dial: '+855' },
          { iso2: 'CM', name: 'Camer√∫n', dial: '+237' },
          { iso2: 'CA', name: 'Canad√°', dial: '+1' },
          { iso2: 'QA', name: 'Catar', dial: '+974' },
          { iso2: 'TD', name: 'Chad', dial: '+235' },
          { iso2: 'CZ', name: 'Chequia', dial: '+420' },
          { iso2: 'CL', name: 'Chile', dial: '+56' },
          { iso2: 'CN', name: 'China', dial: '+86' },
          { iso2: 'CY', name: 'Chipre', dial: '+357' },
          { iso2: 'CO', name: 'Colombia', dial: '+57' },
          { iso2: 'KM', name: 'Comoras', dial: '+269' },
          { iso2: 'KP', name: 'Corea del Norte', dial: '+850' },
          { iso2: 'KR', name: 'Corea del Sur', dial: '+82' },
          { iso2: 'CI', name: 'Costa de Marfil', dial: '+225' },
          { iso2: 'CR', name: 'Costa Rica', dial: '+506' },
          { iso2: 'HR', name: 'Croacia', dial: '+385' },
          { iso2: 'CU', name: 'Cuba', dial: '+53' },
          { iso2: 'DK', name: 'Dinamarca', dial: '+45' },
          { iso2: 'DM', name: 'Dominica', dial: '+1767' },
          { iso2: 'EC', name: 'Ecuador', dial: '+593' },
          { iso2: 'EG', name: 'Egipto', dial: '+20' },
          { iso2: 'SV', name: 'El Salvador', dial: '+503' },
          { iso2: 'AE', name: 'Emiratos √Årabes', dial: '+971' },
          { iso2: 'ER', name: 'Eritrea', dial: '+291' },
          { iso2: 'SK', name: 'Eslovaquia', dial: '+421' },
          { iso2: 'SI', name: 'Eslovenia', dial: '+386' },
          { iso2: 'ES', name: 'Espa√±a', dial: '+34' },
          { iso2: 'EE', name: 'Estonia', dial: '+372' },
          { iso2: 'SZ', name: 'Esuatini', dial: '+268' },
          { iso2: 'ET', name: 'Etiop√≠a', dial: '+251' },
          { iso2: 'PH', name: 'Filipinas', dial: '+63' },
          { iso2: 'FI', name: 'Finlandia', dial: '+358' },
          { iso2: 'FJ', name: 'Fiyi', dial: '+679' },
          { iso2: 'FR', name: 'Francia', dial: '+33' },
          { iso2: 'GA', name: 'Gab√≥n', dial: '+241' },
          { iso2: 'GM', name: 'Gambia', dial: '+220' },
          { iso2: 'GE', name: 'Georgia', dial: '+995' },
          { iso2: 'GH', name: 'Ghana', dial: '+233' },
          { iso2: 'GI', name: 'Gibraltar', dial: '+350' },
          { iso2: 'GD', name: 'Granada', dial: '+1473' },
          { iso2: 'GR', name: 'Grecia', dial: '+30' },
          { iso2: 'GL', name: 'Groenlandia', dial: '+299' },
          { iso2: 'GP', name: 'Guadalupe', dial: '+590' },
          { iso2: 'GU', name: 'Guam', dial: '+1671' },
          { iso2: 'GT', name: 'Guatemala', dial: '+502' },
          { iso2: 'GF', name: 'Guayana Francesa', dial: '+594' },
          { iso2: 'GN', name: 'Guinea', dial: '+224' },
          { iso2: 'GQ', name: 'Guinea Ecuatorial', dial: '+240' },
          { iso2: 'GW', name: 'Guinea-Bis√°u', dial: '+245' },
          { iso2: 'GY', name: 'Guyana', dial: '+592' },
          { iso2: 'HT', name: 'Hait√≠', dial: '+509' },
          { iso2: 'HN', name: 'Honduras', dial: '+504' },
          { iso2: 'HK', name: 'Hong Kong', dial: '+852' },
          { iso2: 'HU', name: 'Hungr√≠a', dial: '+36' },
          { iso2: 'IN', name: 'India', dial: '+91' },
          { iso2: 'ID', name: 'Indonesia', dial: '+62' },
          { iso2: 'IR', name: 'Ir√°n', dial: '+98' },
          { iso2: 'IQ', name: 'Irak', dial: '+964' },
          { iso2: 'IE', name: 'Irlanda', dial: '+353' },
          { iso2: 'IS', name: 'Islandia', dial: '+354' },
          { iso2: 'KY', name: 'Islas Caim√°n', dial: '+1345' },
          { iso2: 'CK', name: 'Islas Cook', dial: '+682' },
          { iso2: 'FO', name: 'Islas Feroe', dial: '+298' },
          { iso2: 'FK', name: 'Islas Malvinas', dial: '+500' },
          { iso2: 'MP', name: 'Islas Marianas', dial: '+1670' },
          { iso2: 'MH', name: 'Islas Marshall', dial: '+692' },
          { iso2: 'SB', name: 'Islas Salom√≥n', dial: '+677' },
          { iso2: 'TC', name: 'Islas Turcas y Caicos', dial: '+1649' },
          { iso2: 'VI', name: 'Islas V√≠rgenes (EE.UU.)', dial: '+1340' },
          { iso2: 'VG', name: 'Islas V√≠rgenes (RU)', dial: '+1284' },
          { iso2: 'IL', name: 'Israel', dial: '+972' },
          { iso2: 'IT', name: 'Italia', dial: '+39' },
          { iso2: 'JM', name: 'Jamaica', dial: '+1876' },
          { iso2: 'JP', name: 'Jap√≥n', dial: '+81' },
          { iso2: 'JO', name: 'Jordania', dial: '+962' },
          { iso2: 'KZ', name: 'Kazajist√°n', dial: '+7' },
          { iso2: 'KE', name: 'Kenia', dial: '+254' },
          { iso2: 'KG', name: 'Kirguist√°n', dial: '+996' },
          { iso2: 'KI', name: 'Kiribati', dial: '+686' },
          { iso2: 'KW', name: 'Kuwait', dial: '+965' },
          { iso2: 'LA', name: 'Laos', dial: '+856' },
          { iso2: 'LS', name: 'Lesoto', dial: '+266' },
          { iso2: 'LV', name: 'Letonia', dial: '+371' },
          { iso2: 'LB', name: 'L√≠bano', dial: '+961' },
          { iso2: 'LR', name: 'Liberia', dial: '+231' },
          { iso2: 'LY', name: 'Libia', dial: '+218' },
          { iso2: 'LI', name: 'Liechtenstein', dial: '+423' },
          { iso2: 'LT', name: 'Lituania', dial: '+370' },
          { iso2: 'LU', name: 'Luxemburgo', dial: '+352' },
          { iso2: 'MO', name: 'Macao', dial: '+853' },
          { iso2: 'MG', name: 'Madagascar', dial: '+261' },
          { iso2: 'MY', name: 'Malasia', dial: '+60' },
          { iso2: 'MW', name: 'Malaui', dial: '+265' },
          { iso2: 'MV', name: 'Maldivas', dial: '+960' },
          { iso2: 'ML', name: 'Mal√≠', dial: '+223' },
          { iso2: 'MT', name: 'Malta', dial: '+356' },
          { iso2: 'MA', name: 'Marruecos', dial: '+212' },
          { iso2: 'MQ', name: 'Martinica', dial: '+596' },
          { iso2: 'MU', name: 'Mauricio', dial: '+230' },
          { iso2: 'MR', name: 'Mauritania', dial: '+222' },
          { iso2: 'YT', name: 'Mayotte', dial: '+262' },
          { iso2: 'MX', name: 'M√©xico', dial: '+52' },
          { iso2: 'FM', name: 'Micronesia', dial: '+691' },
          { iso2: 'MD', name: 'Moldavia', dial: '+373' },
          { iso2: 'MC', name: 'M√≥naco', dial: '+377' },
          { iso2: 'MN', name: 'Mongolia', dial: '+976' },
          { iso2: 'ME', name: 'Montenegro', dial: '+382' },
          { iso2: 'MS', name: 'Montserrat', dial: '+1664' },
          { iso2: 'MZ', name: 'Mozambique', dial: '+258' },
          { iso2: 'MM', name: 'Myanmar', dial: '+95' },
          { iso2: 'NA', name: 'Namibia', dial: '+264' },
          { iso2: 'NR', name: 'Nauru', dial: '+674' },
          { iso2: 'NP', name: 'Nepal', dial: '+977' },
          { iso2: 'NI', name: 'Nicaragua', dial: '+505' },
          { iso2: 'NE', name: 'N√≠ger', dial: '+227' },
          { iso2: 'NG', name: 'Nigeria', dial: '+234' },
          { iso2: 'NU', name: 'Niue', dial: '+683' },
          { iso2: 'NO', name: 'Noruega', dial: '+47' },
          { iso2: 'NC', name: 'Nueva Caledonia', dial: '+687' },
          { iso2: 'NZ', name: 'Nueva Zelanda', dial: '+64' },
          { iso2: 'OM', name: 'Om√°n', dial: '+968' },
          { iso2: 'PK', name: 'Pakist√°n', dial: '+92' },
          { iso2: 'PW', name: 'Palaos', dial: '+680' },
          { iso2: 'PS', name: 'Palestina', dial: '+970' },
          { iso2: 'PA', name: 'Panam√°', dial: '+507' },
          { iso2: 'PG', name: 'Pap√∫a Nueva Guinea', dial: '+675' },
          { iso2: 'PE', name: 'Per√∫', dial: '+51' },
          { iso2: 'PF', name: 'Polinesia Francesa', dial: '+689' },
          { iso2: 'PL', name: 'Polonia', dial: '+48' },
          { iso2: 'PT', name: 'Portugal', dial: '+351' },
          { iso2: 'PR', name: 'Puerto Rico', dial: '+1787' },
          { iso2: 'GB', name: 'Reino Unido', dial: '+44' },
          { iso2: 'CF', name: 'Rep√∫blica Centroafricana', dial: '+236' },
          { iso2: 'CD', name: 'Rep. Dem. del Congo', dial: '+243' },
          { iso2: 'CG', name: 'Rep√∫blica del Congo', dial: '+242' },
          { iso2: 'DO', name: 'Rep√∫blica Dominicana', dial: '+1809' },
          { iso2: 'RE', name: 'Reuni√≥n', dial: '+262' },
          { iso2: 'RW', name: 'Ruanda', dial: '+250' },
          { iso2: 'RO', name: 'Rumania', dial: '+40' },
          { iso2: 'RU', name: 'Rusia', dial: '+7' },
          { iso2: 'WS', name: 'Samoa', dial: '+685' },
          { iso2: 'AS', name: 'Samoa Americana', dial: '+1684' },
          { iso2: 'LC', name: 'Santa Luc√≠a', dial: '+1758' },
          { iso2: 'KN', name: 'San Crist√≥bal y Nieves', dial: '+1869' },
          { iso2: 'SM', name: 'San Marino', dial: '+378' },
          { iso2: 'ST', name: 'Santo Tom√© y Pr√≠ncipe', dial: '+239' },
          { iso2: 'VC', name: 'San Vicente y Granadinas', dial: '+1784' },
          { iso2: 'SN', name: 'Senegal', dial: '+221' },
          { iso2: 'RS', name: 'Serbia', dial: '+381' },
          { iso2: 'SC', name: 'Seychelles', dial: '+248' },
          { iso2: 'SL', name: 'Sierra Leona', dial: '+232' },
          { iso2: 'SG', name: 'Singapur', dial: '+65' },
          { iso2: 'SY', name: 'Siria', dial: '+963' },
          { iso2: 'SO', name: 'Somalia', dial: '+252' },
          { iso2: 'LK', name: 'Sri Lanka', dial: '+94' },
          { iso2: 'ZA', name: 'Sud√°frica', dial: '+27' },
          { iso2: 'SD', name: 'Sud√°n', dial: '+249' },
          { iso2: 'SS', name: 'Sud√°n del Sur', dial: '+211' },
          { iso2: 'SE', name: 'Suecia', dial: '+46' },
          { iso2: 'CH', name: 'Suiza', dial: '+41' },
          { iso2: 'SR', name: 'Surinam', dial: '+597' },
          { iso2: 'TH', name: 'Tailandia', dial: '+66' },
          { iso2: 'TW', name: 'Taiw√°n', dial: '+886' },
          { iso2: 'TZ', name: 'Tanzania', dial: '+255' },
          { iso2: 'TJ', name: 'Tayikist√°n', dial: '+992' },
          { iso2: 'TL', name: 'Timor Oriental', dial: '+670' },
          { iso2: 'TG', name: 'Togo', dial: '+228' },
          { iso2: 'TK', name: 'Tokelau', dial: '+690' },
          { iso2: 'TO', name: 'Tonga', dial: '+676' },
          { iso2: 'TT', name: 'Trinidad y Tobago', dial: '+1868' },
          { iso2: 'TN', name: 'T√∫nez', dial: '+216' },
          { iso2: 'TM', name: 'Turkmenist√°n', dial: '+993' },
          { iso2: 'TR', name: 'Turqu√≠a', dial: '+90' },
          { iso2: 'TV', name: 'Tuvalu', dial: '+688' },
          { iso2: 'UA', name: 'Ucrania', dial: '+380' },
          { iso2: 'UG', name: 'Uganda', dial: '+256' },
          { iso2: 'UY', name: 'Uruguay', dial: '+598' },
          { iso2: 'UZ', name: 'Uzbekist√°n', dial: '+998' },
          { iso2: 'VU', name: 'Vanuatu', dial: '+678' },
          { iso2: 'VA', name: 'Vaticano', dial: '+379' },
          { iso2: 'VE', name: 'Venezuela', dial: '+58' },
          { iso2: 'VN', name: 'Vietnam', dial: '+84' },
          { iso2: 'WF', name: 'Wallis y Futuna', dial: '+681' },
          { iso2: 'YE', name: 'Yemen', dial: '+967' },
          { iso2: 'DJ', name: 'Yibuti', dial: '+253' },
          { iso2: 'ZM', name: 'Zambia', dial: '+260' },
          { iso2: 'ZW', name: 'Zimbabue', dial: '+263' }
        ];

        // DOM elements
        const dropdown = document.getElementById('countryDropdown');
        if (!dropdown) return;

        const trigger = dropdown.querySelector('.country-trigger');
        const popover = dropdown.querySelector('.country-popover');
        const countryList = dropdown.querySelector('.country-list');
        const searchInput = dropdown.querySelector('.country-search');
        const selectedFlag = document.getElementById('selectedFlag');
        const selectedIso = document.getElementById('selectedIso');
        const selectedDial = document.getElementById('selectedDial');
        const hiddenInput = document.getElementById('countryCode');
        const hiddenIso2 = document.getElementById('countryIso2');

        let allCountries = [];
        let filteredCountries = [];

        // Render countries (priority first, then alphabetical)
        function renderCountries() {
          const priorityCountries = COUNTRIES.filter(c => c.priority);
          const regularCountries = COUNTRIES.filter(c => !c.priority).sort((a, b) => a.name.localeCompare(b.name));
          allCountries = [...priorityCountries, ...regularCountries];
          filteredCountries = [...allCountries];
          updateList();
        }

        // Update country list
        function updateList() {
          countryList.innerHTML = '';
          filteredCountries.forEach(country => {
            const option = document.createElement('button');
            option.type = 'button';
            option.className = 'country-option';
            option.setAttribute('role', 'option');
            option.setAttribute('data-dial', country.dial);
            option.setAttribute('data-iso2', country.iso2);

            const flagUrl = `https://flagcdn.com/w20/${country.iso2.toLowerCase()}.png`;

            option.innerHTML = `
              <img src="${flagUrl}" alt="${country.iso2}" class="country-flag">
              <span class="country-option-name">${country.name}</span>
              <span class="country-option-dial">${country.dial}</span>
            `;

            // Mark selected
            if (country.dial === hiddenInput.value) {
              option.classList.add('selected');
            }

            option.addEventListener('click', () => selectCountry(country));
            countryList.appendChild(option);
          });
        }

        // Select country
        function selectCountry(country) {
          // Update trigger UI
          selectedFlag.src = `https://flagcdn.com/w20/${country.iso2.toLowerCase()}.png`;
          selectedFlag.alt = country.iso2;
          selectedIso.textContent = country.iso2;
          selectedDial.textContent = country.dial;

          // Update hidden inputs
          hiddenInput.value = country.dial;
          hiddenIso2.value = country.iso2;

          // Dispatch change event for compatibility
          const changeEvent = new Event('change', { bubbles: true });
          hiddenInput.dispatchEvent(changeEvent);

          // Close popover
          closePopover();

          console.log(`‚úì Country selected: ${country.name} (${country.dial})`);
        }

        // Open/close popover
        function togglePopover() {
          const isOpen = popover.hasAttribute('hidden');
          if (isOpen) {
            openPopover();
          } else {
            closePopover();
          }
        }

        function openPopover() {
          popover.removeAttribute('hidden');
          trigger.setAttribute('aria-expanded', 'true');

          // Desktop: Portalear al body para escapar del clipping
          if (window.innerWidth > 768) {
            const rect = trigger.getBoundingClientRect();
            document.body.appendChild(popover);
            popover.classList.add('portaled');
            popover.style.position = 'fixed';
            popover.style.top = `${rect.bottom + 8}px`;
            popover.style.left = `${rect.left}px`;
            popover.style.zIndex = '5000';
          } else {
            // Mobile: Bloquear scroll del body
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
          }

          searchInput.focus();
        }

        function closePopover() {
          popover.setAttribute('hidden', '');
          trigger.setAttribute('aria-expanded', 'false');

          // Devolver al contenedor original si est√° portaleado
          if (popover.classList.contains('portaled')) {
            dropdown.appendChild(popover);
            popover.classList.remove('portaled');
            popover.style.position = '';
            popover.style.top = '';
            popover.style.left = '';
            popover.style.zIndex = '';
          }

          // Restaurar scroll del body
          document.body.style.overflow = '';
          document.documentElement.style.overflow = '';

          searchInput.value = '';
          filteredCountries = [...allCountries];
          updateList();
        }

        // Search functionality
        function handleSearch(e) {
          const query = e.target.value.toLowerCase();
          filteredCountries = allCountries.filter(country =>
            country.name.toLowerCase().includes(query) ||
            country.dial.includes(query) ||
            country.iso2.toLowerCase().includes(query)
          );
          updateList();
        }

        // Close on click outside
        function handleClickOutside(e) {
          if (!dropdown.contains(e.target)) {
            closePopover();
          }
        }

        // Close on ESC key
        function handleKeydown(e) {
          if (e.key === 'Escape' && !popover.hasAttribute('hidden')) {
            closePopover();
            trigger.focus();
          }
        }

        // Reposicionar popover cuando hay scroll o resize (solo desktop)
        function repositionPopover() {
          if (!popover.hasAttribute('hidden') && popover.classList.contains('portaled')) {
            const rect = trigger.getBoundingClientRect();
            popover.style.top = `${rect.bottom + 8}px`;
            popover.style.left = `${rect.left}px`;
          }
        }

        // Event listeners
        trigger.addEventListener('click', togglePopover);
        searchInput.addEventListener('input', handleSearch);
        document.addEventListener('click', handleClickOutside);
        document.addEventListener('keydown', handleKeydown);

        // Listeners para reposicionar en desktop
        window.addEventListener('scroll', repositionPopover, true);
        window.addEventListener('resize', repositionPopover);

        // Initialize
        renderCountries();
        console.log('‚úì Custom country dropdown initialized');

      })();
    </script>
  </body>
</html>